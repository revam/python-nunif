# iw3-player

iw3-playerは、セルフホストのステレオメディア再生環境です。  
iw3で3Dに変換済みのメディアをPC側から配信し、VRデバイスからWebXRのアプリで再生できます。

ステレオメディアに対するあらゆる操作に対応しています。  
特に静止画像においては一瞬の操作で人物を実物大に調節可能です。  
写真を実物大で表示することで、没入感が大幅に向上し、VRの中で思い出が鮮やかに蘇ります。

![Screenshot](https://github.com/user-attachments/assets/708d03bc-da99-4cdb-a8e4-2ec247e7e3a2)

## 動作環境

- **バックエンド（Python）**: Linux, Windows で動作確認済み。
- **フロントエンド（JavaScript）**: Meta Quest 2, PC 版 Google Chrome, Android スマートフォンで動作確認済み。

## 対応フォーマット

- **画像**: `.png`, `.jpg`, `.jpeg`, `.webp`
- **動画**: `.mp4`, `.mkv`, `.webm`
- **アーカイブ**: `.zip`

対応している動画形式は、ブラウザに依存します。Meta Quest 2のブラウザでは、iw3で一般的に使用される、mp4, mkv, h264, h265の全ての組み合わせに対応しています。PC版のGoogle Chromeはh265に対応していませんでした。
Meta Quest 2では、4K動画もスムーズに再生できました。

字幕トラックは、動画の内蔵字幕(subtitle stream)と外部字幕ファイル(`.srt` / `.vtt`)に対応しています。外部字幕ファイルは動画と同じファイル名+(`.srt` or `.vtt`)で配置すると最優先の字幕トラックしてロードされます。 
動画の内蔵字幕はバックエンドが`.vtt`に変換して配信します。

ステレオフォーマットはiw3が出力するファイル名のタグに従って推定されます。またファイル名にステレオファーマットのタグがない場合でも親フォルダにあればそれが使用されます。アーカイブの場合は、アーカイブのファイル名も使用されます。

## 起動方法

### Windows

`iw3-player-gui.bat` を実行すると GUI 画面が起動します。
`iw3-player-gui.bat`が存在しない場合は、`update.bat`の後に`update-installer.bat`を実行すると現れます。

![GUI](https://github.com/user-attachments/assets/bdf2666e-bd2a-4b3f-827b-fb95be174507)

### コマンドライン（CLI）

以下のコマンドで起動できます。

**GUI モード**
```bash
python -m iw3.player.gui
```

**CLI モード**
```bash
python -m iw3.player --root /path/to/your/media
```

サーバー起動後、ターミナルまたは GUI に表示される `https://[IPアドレス]:1304` に、VR デバイスのブラウザからアクセスしてください。

#### SSL 警告について

iw3-player バックエンドは WebXR の必須要件であるHTTPS通信を実現するために起動時に自己署名証明書を生成します。
そのため初回アクセス時に「保護されていない通信」等の警告が表示されますが以下の手順で続行できます：

1. 「詳細設定」をクリック
2. 「[IPアドレス] にアクセスする」を選択

このページをお気に入りに登録しておくことで次回以降の警告をスキップできます。

「自分の PC」をブラウザに信頼させるシンプルな方法が提供されていないためこのような手順が必要になります。これは悪い習慣です。

## 各操作・設定画面の説明

### VR コントローラー基本操作

- **メニュー開閉**: トリガー、B / Y ボタン
- **決定 / 選択**: トリガー（人差し指）
- **画像送り**: スティック左右（画像再生時）
- **シーク**: スティック左右（動画再生時）
- **ページめくり**: スティック上下（エクスプローラー）

スクリーンに対する操作はScreen Settingに記述します。

####  Screen Settings

スクリーンの形状や空間上の配置を詳細に調節できます。もっとも頻繁に使う機能です。  
(`Stick X`はスティックの左右、`Stick Y`はスティックの上下、`Tilt`はコントローラ自体の回転、`Move`はコントローラー自体の移動を表しています)

| 項目 | ショートカット | 操作内容 |
| :--- | :--- | :--- |
| `Screen Size` | `[Grip + Stick X]` | スクリーンの物理的な大きさ |
| `Tilt` | `[Trigger + Tilt]` | 画面の垂直方向の傾き |
| `Distance` | `[Stick Y]` | 画面との距離（ズーム） |
| `Scale` | `[Grip + Stick Y]` | 視差を調整。オブジェクトの見た目の大きさ |
| `Pos X` / `Pos Y` | `[Grip + Move]` | 画面の水平・垂直位置を移動 |
| `Curvature` | - | 画面の曲率（カーブ）を調整 |
| `Edge Fade` | - | 画面端を滑らかに消し込む |
| `Background` | - | 背景の明るさを調整。背景画像が設定されている場合は無視される |

これらの操作は、行われる操作と知覚が一致しないことがあります。
詳しくは[スクリーン操作と知覚](#スクリーン操作と知覚)に記述しています。読むことを強くおすすめします。

#### Color Settings

画質や色味をリアルタイムに補正します。  
ほとんどのケースでは使わないのが一番でしょう。しかしときどき非常に欲しくなる機能です。

- LUT (カラープロファイル)
- コントラスト(Contrast)、明るさ(Brightness)、色相(Hue)、彩度(Saturation)、ガンマ値(Gamma)の調整

LUTは、`public/lut/`に`.cube`ファイルを配置することでカスタマイズできます。  
`haldclut2cube.py`を使うと[Identity HaldCLUT画像](https://rawpedia.rawtherapee.com/File:Hald_CLUT_Identity.tif)に適用した効果を`.cube`ファイルに変換できます。

#### Env Settings

視聴環境を設定します。  
あまり本質的な機能ではありませんが、空を見ながらメディアを視聴するのは良い体験です。足元が不安な場合は床を設置することもできます。

- `Skybox`: 360度背景画像の設定、向きと明るさの調節
- `3D Model`: シーンモデルをロード

背景画像は、`public/environments/`に`.hdr`または`.exr`ファイルを配置することでカスタマイズできます。
背景画像(HDRI, IBL)は、以下で入手できます。

- [Poly Haven](https://polyhaven.com/)
- [ambientCG](https://ambientcg.com/)

3D Modelは、`public/environments/`に`.glb`ファイルを配置することでカスタマイズできます。
`.glb`はglTFのバイナリ形式です。圧縮(Draco)とアニメーションにも対応しています。ライトは環境光のみです。
Blenderで作成したシーンをエクスポートできます。

#### Subtitle Settings

動画字幕の表示設定です。

- 字幕の表示 ON / OFF
- 字幕トラックの切り替え
- 字幕の表示位置、奥行き、フォントサイズ、視差の調節

字幕の調節については、[字幕位置の調節](#字幕位置の調節)を参照してください。

#### Render Settings

レンダリングエンジンの高度な設定です。**反映にはブラウザのリロードが必要です。**

- `Font`: **UI**のフォント/言語を選択できます。主にファイルエクスプローラー用です。
- `Antialias`: 物の輪郭に出るギザギザ（ジャギー）を滑らかにします。
- `Super Sampling`: VR空間内の解像度（ピクセル密度）を上げます。
- `Target Frame Rate`: WebXR表示の時FPSを調節します。
- `Video Mipmap`: 動画テクスチャに Mipmap を適用し、遠景のチラつきを抑えます。

これらの設定には画質とバッテリー消費のトレードオフがあります。  
以下を許容できる場合はoffにできます。

- `Antialias`: スクリーンの端がギザギザになります。しかし、`Edge Fade`を使えば気になりません。
- `Super Sampling`: Meta QuestはWebXRのデフォルト解像度が低いため1にすると画質が悪くなります。他のデバイスでは下げられる可能性があります(他のデバイスでテストしていないため詳しくはわかりません)。
- `Video Mipmap`: スクリーンを遠くに置いたり小さくしたときにピクセルが乱れます。適度な位置と大きさ見る場合は気になりません。

##### Fontと言語について

iw3-playerのUIではウェブページとは異なる方法(MSDF)で文字が描画されています。フォントが不適切だとファイル名に含まれるアルファベット以外の文字が表示できないことがあります。
現在以下のフォントと言語に対応しています。

| Font       | 内容
|------------|-----------------------------
|`NotoSansJP`| Japanese (JIS Level 1 & 2)
|`NotoSansSC`| Simplified Chinese (Standard table)
|`NotoSansTC`| Traditional Chinese (MOE Standard)
|`NotoSansKR`| Korean (All Hangul syllables)
|`NotoSans`  | Latin / Cyrillic. English, Russian, European, etc.

デフォルトではブラウザの言語設定から自動で適切なフォントが使用されます。文字化けする場合は明示的に選択してください。フォントを選択しても文字化けする場合は、その文字はフォントファイルに含まれていません。

対応してほしい文字や言語があれば、issueに投稿してください。

なお、字幕はWebブラウザの機能(Canvas)を使って描画しているためこの問題はありません。

## セキュリティーとプライバシー

### サーバーへのアクセス

バックエンドサーバーはデフォルトではパスワードなしで起動します。
同じローカルネットワーク内からしかアクセスできませんが、必要性を感じる場合はユーザー名とパスワードを設定できます。

### バックエンドのストレージ

バックエンドは画像と動画のサムネイル、字幕データをキャッシュとして保存します。
OSのエクスプローラー等で見ることはできませんが、生のデータが保存されています。
削除にはいくつかの方法があります。

- `nunif/tmp/iw3_player_cache`を削除
- `--clear-cache`オプションでバックエンドを起動 (起動ごとに削除)
- サーバーの`/factory_reset.html`にアクセスしてファクトリーリセットを行う

サムネイルのキーはファイル名と最終更新日のハッシュ値が使われており生のファイル名は保存されていません。

### ブラウザのストレージ

ブラウザ側のデータはIndexedDBに保存されています。
これには以下のデータが含まれます。

- プレイヤーの全体設定
- ファイルごとのスクリーン設定
- 最後に開いたファイルのパス

これは同じアドレス:ポートで起動するサイト以外からは読み取れませんが、生のファイル名を保存しないように注意を払っています。  
ファイルごとの設定では、キーは `ファイル名+最終更新日` のハッシュ値（SHA256）です。生のファイル名は保存されていません。  
最後に開いたファイルのパスはバックエンドが初回起動時に生成する鍵を使ってAES-GCMで暗号化されています。同じバックエンドがあると復号できますが、ブラウザ側のデータ単体では復号できません。

削除したい場合は、`/factory_reset.html`にアクセスしてファクトリーリセットを行ってください。

## スクリーン操作と知覚

ステレオ画像の表示では3Dシーン上のスクリーンの操作と知覚が一致しないことがあります。
このセクションでは各操作の知覚効果と推奨される調節方法について記述します。

### スケール

スクリーンのスケール設定は、左右のスクリーンのベースラインを変更します。左カメラと右カメラでスクリーンの水平位置をずらしてレンダリングします。これはIPDやEye Separationと呼ばれる操作です。

知覚できる効果として、オブジェクトの実寸サイズを調節できます。人物を適切な身長に調節したり、50cmにしたり4mにしたりできます。

### スクリーンサイズとスクリーン距離

スクリーンサイズの変更と距離(Distance)の変更はどちらも同じ"ズーム"操作として知覚されます。  
同じように見える異なる設定の組み合わせがあると操作が複雑になり混乱します。iw3-playerの設計ではズームはスクリーンの距離を変えることで行います。

スクリーンサイズを変更できることのメリットは他の設定に対して追加でズーム操作を行うことができることです。  
スクリーンサイズの変更は他の設定の限界を超えるときだけ使用します。

1. 基本的なズーム操作は距離の変更で行う
2. 最小距離よりもスクリーンに近づきたい場合はスクリーンサイズを大きくする 
3. 最小スケールよりもオブジェクトを小さく見たい場合はスクリーンサイズを小さくする

### オブジェクト/人物の厚さの見え方

1. スクリーン距離が近くなるほどオブジェクトが平面に見えます
2. スケールが小さくなるほどオブジェクトが平面に見えます
3. ステレオメディアの3D強度（視差）が低いほど平面に見えます

3D強度はiw3による3D変換時に指定します。iw3-player上では、距離とスケールだけ変更できます。

スケールについては、iw3上でも`Your Own Size (--ipd-offset)`オプションで変更できますが、それを使うことはおすすめしません。それは左右に黒いパディングを追加し、iw3-player上では背景が純粋な黒以外のときにアーティファクトが発生する原因になります。

### 没入感のある表示に調節する方法

以下方法でシーンをまるで現実であるかのように調節できます。

1. 人物が小さすぎるときはスケールを大きくする
2. 人物が大きすぎるときはスケールを小さくする
3. 人物が薄すぎるときは距離を大きくする
4. 人物が平面すぎないときは距離を小さくできる
5. スケールを最小にしても人物が大きすぎるときはスクリーンサイズを小さくする
6. 距離を最小にしても遠すぎるときはスクリーンを大きくする

すべてを満たすように調節します。慣れると片手のコントローラーだけで数秒でできるようになります。

これは教師データを作れば機械学習で自動化ができそうです。

## 字幕位置の調節

3D映像のソフト字幕は非常に見づらいです。これは複数の視差が混在していることが原因です。

1. 左右のカメラで異なる映像をレンダリングすることによる擬似的な視差（ステレオメディアに埋め込まれた視差とScreenのScale設定による視差）
2. 左右のカメラで3D空間をレンダリングすることによる視差

単純な3D字幕は、2のみであり、映像は1と2の複合効果です。
そこで字幕に擬似的な視差を追加する`Eye Separation`設定を追加しました。

字幕の位置は`Eye Separation`設定で調節してください。字幕が映像よりも前に表示されるように調節すると字幕が読みやすくなります。

## 開発環境について

iw3-player は、[gemini-cli](https://github.com/google-gemini/gemini-cli) のチャットインターフェースを使って開発されました。
バックエンドとフロントエンドのコードの99%以上は、Geminiによって書かれました。
私は詳細な仕様を指示し繰り返し詳細なフィードバックを行いました。

最初の開発には、Gemini API Key (Tier 1) を使用して約100ドルの費用と2週間がかかりました。

### vendor.bundle.jsのビルド方法

iw3-playerはバニラ JavaScriptで開発されていますが、`@pmndrs/uikit`の依存関係が複雑なため外部ライブラリだけnpmでビルドしています。  
実行時にはビルド済みのファイルをダウンロードするようにしていますが以下の方法でビルドできます。

```
npm install
npm run build
```

`public/lib`に出力されます。

### `nunif`への依存関係

バックエンド(cli)とフロントエンドは`nunif`に依存していません。`dir_config.py`を調節すればスタンドアローンで動作します。

GUIやその他のユーティリティは`nunif`に依存しています。
